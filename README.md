# CortexFlow — Cognitive Attention Breakdown Prediction Engine

CortexFlow is a neuroscience-grounded ML pipeline that predicts real-time **cognitive attention breakdowns** during computer-based work sessions. It models latent cognitive states (Instability, Drift, Fatigue, ECN, DMN, Salience Network) derived from behavioral telemetry and predicts breakdown probability using a trained logistic classifier with SHAP-style attribution and Bayesian personalization.

> **For the backend team:** The ML core lives in `cortex_core/`. Import `CortexPredictor` and `StateEngine` to integrate. See the [API Reference](#api-reference) below.

---

## Project Structure

```
Leptons-Insos/
├── cortex_core/          # ML core (import this)
│   ├── __init__.py       # Package entrypoint
│   ├── logic.py          # StateEngine — real-time latent state updates
│   └── predictor.py      # CortexPredictor, BayesianAdapter
├── scripts/
│   ├── preprocess.py     # Data pipeline (NASA-TLX, MOOC, mouse tracking)
│   └── train.py          # Train and save baseline_model.joblib
├── models/
│   └── baseline_model.joblib  # Pre-trained baseline (ready to use)
├── tests/
│   └── verify_session.py # End-to-end simulation and verification
├── extensions/           # CortexFlow Chrome Extension
│   ├── manifest.json     # MV3 manifest
│   ├── config.js         # Central config (API URL, thresholds)
│   ├── background/       # Service worker (session + tab tracking)
│   ├── content/          # Telemetry collector + overlay UI
│   ├── popup/            # Toolbar popup (NLP task classifier)
│   └── icons/            # Extension icons
├── data/                 # Raw + processed datasets (see data/README below)
└── requirements.txt
```

---

## Quickstart

### 1. Install dependencies
```bash
pip install -r requirements.txt
```

### 2. Run verification (no setup needed — uses pre-trained model)
```bash
python tests/verify_session.py
```

### 3. Retrain from data (optional)
```bash
# First, preprocess raw datasets
python scripts/preprocess.py

# Then train
python scripts/train.py
```

---

## API Reference

### `StateEngine` (`cortex_core.logic`)

Converts raw behavioral telemetry into latent cognitive state variables per time step.

```python
from cortex_core import StateEngine

engine = StateEngine(expected_duration_min=60)

# Feed raw telemetry at each timestep
I_t, D_t, F_t = engine.update_latent_states(telemetry_dict, session_duration_sec)

# Update network dynamics
ECN_t, DMN_t, SN_t = engine.update_temporal_dynamics(E_t, Idle_t, Task_t, SwitchPressure_t)

# Check for breakdown
is_breakdown, A_t = engine.detect_breakdown()

# Get overall attention risk score [0–1]
risk = engine.get_attention_risk()
```

**Telemetry dict keys:**

| Key | Description |
|-----|-------------|
| `switch_rate` | App / tab switch frequency (events/min) |
| `motor_var` | Mouse motor variability (maxdev proxy) |
| `distractor_attempts` | Distractor click attempts |
| `idle_ratio` | Fraction of session in idle state |
| `scroll_entropy` | Randomness of scroll behavior |
| `passive_playback` | Fraction of time in passive media playback |

---

### `CortexPredictor` (`cortex_core.predictor`)

Predicts breakdown probability and explains the prediction.

```python
from cortex_core import CortexPredictor

predictor = CortexPredictor(model_path='models/baseline_model.joblib')

# Build feature vector from current + previous state
state = {'I_t': ..., 'D_t': ..., 'F_t': ..., 'ECN_t': ..., 'A_t': ...}
x_vec = predictor.construct_feature_vector(state, previous_state=prev_state)

# Predict breakdown probability [0–1]
prob = predictor.predict_breakdown_prob(x_vec)

# SHAP-style attribution — returns dict of features sorted by contribution
explanation = predictor.explain_prediction(x_vec)
# e.g. {'Conflict(A_t)': 0.38, 'Instability': 0.27, ...}
```

**Feature vector:** `[I_t, D_t, F_t, ECN_t, A_t, delta_I, delta_D]`

---

### `BayesianAdapter` (`cortex_core.predictor`)

Online Bayesian personalization — adapts predictor weights from user feedback.

```python
from cortex_core import BayesianAdapter

adapter = BayesianAdapter(predictor, prior_variance=0.1)

# After each timestep, record what actually happened
adapter.record_feedback(x_vec, actual_breakdown=1)  # 1=breakdown, 0=no breakdown
# Model auto-adapts once 5+ interactions are recorded
```

---

## Data Sources

Raw data is **not committed** (too large). Processed outputs in `data/processed/` are generated by `scripts/preprocess.py`.

| Dataset | Description | Variable Mapped |
|---------|-------------|-----------------|
| NASA-TLX (`data/raw/nasa_tlx/`) | Subjective cognitive load ratings | Fatigue (F_t), Instability (I_t) |
| NTHU MOOC (`data/raw/mooc/`) | Online learning engagement traces | Drift (D_t) |
| Mouse Tracking (`data/raw/mouse_tracking/`) | Stroop task `.mt` files | Motor variability, RT proxy |

---

## Model Details

- **Algorithm:** Logistic Regression with L2 regularization
- **Input features:** 7-dim vector `[I_t, D_t, F_t, ECN_t, A_t, ΔI, ΔD]`
- **Output:** Breakdown probability ∈ [0, 1]
- **Baseline weights (untrained mode):** `[0.5, 0.4, 0.2, -0.3, 0.6, 0.2, 0.1]` (from technical report)
- **Training samples:** 2,000 synthetic sessions from real data distributions
- **Positive class rate:** ~15% (breakdown events)

---

## Branch Structure

| Branch | Purpose |
|--------|---------|
| `main` | Stable ML core — backend integration target |
| `extension` | CortexFlow Chrome Extension module |
| `taksh` | Feature development |
